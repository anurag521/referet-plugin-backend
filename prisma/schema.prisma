
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

model Shop {
  id          String     @id @default(uuid())
  shopId      String     @unique @map("shop_id") // myshopify.com domain
  shopDomain  String?    @unique @map("shop_domain") 
  accessToken String     @map("access_token") 
  plan        String     @default("standard") @map("shop_plan")
  isActive    Boolean    @default(true) @map("is_active")
  campaigns   Campaign[]
  referrals   Referral[]
  rewards     Reward[]
  fraudFlags  FraudFlag[]
  auditLogs   AuditLog[]
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  @@map("shops")
}

model Campaign {
  id                    String   @id @default(uuid())
  shopId                String   @map("shop_id")
  shop                  Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  // Basics
  name                  String
  status                String   @default("DRAFT") // DRAFT, SCHEDULED, ACTIVE
  startDate            DateTime? @map("start_date")
  endDate              DateTime? @map("end_date")
  
  // Rewards
  rewardRecipient       String   @default("BOTH") @map("reward_recipient") // BOTH, REFERRER, REFERRED
  
  referrerRewardValue   Int      @map("referrer_reward_value")
  referrerRewardType    String   @default("FIXED") @map("referrer_reward_type") // FIXED, PERCENTAGE
  
  referredRewardValue   Int      @map("referred_reward_value")
  referredRewardType    String   @default("FIXED") @map("referred_reward_type") // FIXED, PERCENTAGE
  
  // Conditions
  minOrderValue         Int      @default(0) @map("min_order_value")
  usageLimit            String   @default("ONCE") @map("usage_limit") // ONCE, MULTIPLE
  productIds            String[] @default([]) @map("product_ids")

  // Rules
  rewardExpiryDays     Int?     @map("reward_expiry_days")
  issuanceType         String   @default("INSTANT") @map("issuance_type") // COMPLETION_WINDOW, INSTANT, AFTER_X_DAYS
  issuanceDays         Int?     @map("issuance_days")
  cancellationPolicy   String   @default("VOID_ON_RETURN") @map("cancellation_policy") // VOID_ON_RETURN, HOLD_UNTIL_WINDOW_ENDS

  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  referrals Referral[]

  @@map("campaigns")
}

model Referral {
  id                 String   @id @default(uuid())
  shopId             String   @map("shop_id")
  shop               Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  campaignId         String   @map("campaign_id")
  campaign           Campaign @relation(fields: [campaignId], references: [id])
  
  referralCode       String   @unique @map("referral_code")
  referralUrl        String   @map("referral_url")
  
  referrerEmail      String   @map("referrer_email")
  referrerCustomerId String?  @map("referrer_customer_id")
  referrerPhone      String?  @map("referrer_phone")
  
  refereeEmail       String?  @map("referred_email")
  refereeCustomerId  String?  @map("referred_customer_id")
  refereeIpAddress   String?  @map("referred_ip_address")
  
  orderId            String?  @map("order_id")
  orderTotal         Int?     @map("order_total") // In paisa
  orderDate          DateTime? @map("order_date")
  
  status             String   @default("pending") // pending, clicked, purchased, approved, rejected, issued
  
  rewardAmount       Int      @map("reward_amount")
  rewardIssuedDate   DateTime? @map("reward_issued_date")
  
  expiresAt          DateTime @map("expires_at")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  rewards            Reward[]
  clicks             ReferralClick[]
  fraudFlags         FraudFlag[]

  @@index([referrerEmail])
  @@index([referralCode])
  @@map("referrals")
}

model ReferralClick {
  id           String   @id @default(uuid())
  referralId   String   @map("referral_id")
  referral     Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  source       String?  // whatsapp, email, etc
  clickedAt    DateTime @default(now()) @map("clicked_at")

  @@map("referral_clicks")
}

model Reward {
  id           String   @id @default(uuid())
  shopId       String   @map("shop_id")
  shop         Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  referralId   String   @map("referral_id")
  referral     Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  
  rewardType   String   @map("reward_type") // coupon, store_credit, cash
  amount       Int      @map("amount") // in paisa
  
  couponCode   String?  @map("coupon_code")
  couponExpiry DateTime? @map("coupon_expiry")
  couponUsageLimit Int? @map("coupon_usage_limit")
  
  creditBalance Int?    @default(0) @map("credit_balance")
  
  payoutMethod String?  @map("payout_method")
  payoutStatus String?  @default("pending") @map("payout_status")
  payoutId     String?  @map("payout_id")
  
  status       String   @default("pending") // pending, approved, issued, rejected
  rejectionReason String? @map("rejection_reason")
  approvedBy   String?  @map("approved_by")
  approvedAt   DateTime? @map("approved_at")
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("rewards")
}

model FraudFlag {
  id        String   @id @default(uuid())
  shopId    String   @map("shop_id")
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  referralId String? @map("referral_id")
  referral  Referral? @relation(fields: [referralId], references: [id])
  
  fraudType String   @map("fraud_type") // duplicate_device, etc
  fraudScore Decimal  @map("fraud_score") // 0.00 to 1.00
  details   String?  // Store JSON as string if using SQLite/simpler DB, or Json type for Postgres
  actionTaken String? @map("action_taken")
  
  createdAt DateTime @default(now()) @map("created_at")

  @@map("fraud_flags")
}

model AuditLog {
  id           String   @id @default(uuid())
  shopId       String   @map("shop_id")
  shop         Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  action       String
  resourceType String   @map("resource_type")
  resourceId   String?  @map("resource_id")
  oldValues    String?  @map("old_values") // JSON string
  newValues    String?  @map("new_values") // JSON string
  performedBy  String?  @map("performed_by")
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}
